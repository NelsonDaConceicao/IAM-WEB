"use strict";angular.module("iamApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).otherwise({redirectTo:"/"})}]),angular.module("iamApp").controller("MainCtrl",["$route","$location","$window","ApiService",function(a,b,c,d){var e=this;e.labels={route:"Numéro de la ligne",direction:"Direction du bus",stop:"Arrêt de bus",search:"Rechercher",validate:"Valider"},e.informations="Veuillez séléctionner la direction que prenait le bus lorsque vous en êtes descendus.",e.search={route:22,direction:null,stop:null},e.listBuses=null,e.listStops=null,e.listDirections=null,e.listStopsMarkers=[],e.BusTrackedMarker=null,e.busStopPosition=null,e.busTracked=null,e.isDirectionValid=!1,e.isSearchValid=!1,e.map=new google.maps.Map(document.getElementById("map"),{zoom:15,center:{lat:41.980262,lng:-87.668452}}),e.init=function(){d.getDirectionssForRoute(e.search.route,function(a){200==a.status?(e.listDirections=a.data["bustime-response"],console.log(e.listDirections)):console.log(a)})},e.initMap=function(){var a={lat:41.980262,lng:-87.668452},b='<div id="content"><div id="siteNotice"></div><h4 id="firstHeading" class="firstHeading">Vous</h4><div id="bodyContent"><p>Votre position actuelle</p></div></div>',c=new google.maps.InfoWindow({content:b}),d=new google.maps.Marker({position:a,icon:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png",map:e.map,title:"Bureau"});d.addListener("click",function(){c.open(e.map,d)})},e.validateSearch=function(a){if(console.log(a),e.isDirectionValid||null==a.route||null==a.direction)e.isDirectionValid=!1;else{e.isDirectionValid=!0,e.informations="Veuillez séléctionner l'arrêt de bus au-quel vous vous êtes arrêté. Vous pouvez cliquer sur les points de la map afin d'obtenir des informations supplémentaires sur les arrêts";d.getStopsForRoute(a.route,a.direction,function(a){200==a.status?(e.listStops=a.data["bustime-response"],console.log(e.listStops),e.listStops.stops.forEach(function(a,b){e.addBusStop(a)})):console.log(a)})}},e.searchBus=function(a){if(console.log(a),e.isDirectionValid&&null!=a.route&&null!=a.direction&&null!=a.stop){e.isSearchValid=!0,e.informations="Nous avons identifier pour vous le bus ayant le plus de chance de contenir la valise. Vous pouvez suivre à tout moment le déplacement du bus (marqueur rouge) par rapport à votre position (marqueur blueue) et à la position de votre arrêt (marqueur jaune). Si vous souhaitez réinitialiser la recherche, cliquez sur le lien disponible ci-dessus.",e.listStopsMarkers.forEach(function(a,b){a.setMap(null)});var b=JSON.parse(a.stop);e.addBusStop(b),e.busStopPosition={lat:parseFloat(b.lat),lng:parseFloat(b.lon)};d.getBusesForRoute(a.route,function(b){if(200==b.status){e.listBuses=b.data["bustime-response"],console.log(e.listBuses);var c=[];e.listBuses.vehicle.forEach(function(b,d){"Northbound"===a.direction?(console.log("NORTH"),(b.hdg>270||b.hdg<90)&&parseFloat(b.lat)>e.busStopPosition.lat&&c.push(b)):b.hdg<270&&b.hdg>90&&(console.log("SOUTH"),parseFloat(b.lat)<e.busStopPosition.lat&&c.push(b))}),"Northbound"===a.direction?c.sort(function(a,b){return a.lat-b.lat}):c.sort(function(a,b){return a.lat+b.lat}),console.log(c),null!=c[0]&&(e.busTracked=c[0],e.trackBus())}else console.log(b)})}else e.isSearchValid=!1},e.trackBus=function(){var a={lat:parseFloat(e.busTracked.lat),lng:parseFloat(e.busTracked.lon)},b='<div id="content"><div id="siteNotice"></div><h4 id="firstHeading" class="firstHeading">Bus contenant potentiellement votre valise - N° : '+e.busTracked.vid+'</h4><div id="bodyContent"><p>Bus contenant potentiellement votre valise. Durée estimé avant son arrivée à votre arrêt : "busStop.stpnm"</p></div></div>',c=new google.maps.InfoWindow({content:b});null!=e.BusTrackedMarker&&e.BusTrackedMarker.setMap(null),e.BusTrackedMarker=new google.maps.Marker({position:a,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png",map:e.map,title:"Bus"}),e.BusTrackedMarker.addListener("click",function(){c.open(e.map,e.BusTrackedMarker)}),setInterval(function(){d.getVehicle(e.busTracked,function(a){if(200==a.status){var b=a.data["bustime-response"].vehicle;b.forEach(function(a,b){e.busTracked=a}),console.log(e.busTracked);var c={lat:parseFloat(e.busTracked.lat),lng:parseFloat(e.busTracked.lon)},d='<div id="content"><div id="siteNotice"></div><h4 id="firstHeading" class="firstHeading">Bus contenant potentiellement votre valise - N° : '+e.busTracked.vid+'</h4><div id="bodyContent"><p>Bus contenant potentiellement votre valise. Durée estimé avant son arrivée à votre arrêt : "busStop.stpnm"</p></div></div>',f=new google.maps.InfoWindow({content:d});null!=e.BusTrackedMarker&&e.BusTrackedMarker.setMap(null),e.BusTrackedMarker=new google.maps.Marker({position:c,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png",map:e.map,title:"Bus"}),e.BusTrackedMarker.addListener("click",function(){f.open(e.map,e.BusTrackedMarker)});var g=parseFloat(e.busTracked.lat),h=parseFloat(e.busStopPosition.lat),i=parseFloat(1/69/3);console.log(g),console.log(h),console.log(i),"Northbound"===e.search.direction?i>=h-g&&h-g>0&&(e.informations="ATTENTION : IL EST TEMPS DE PARTIR POUR RECUPERER VOTRE BIEN"):i>=g-h&&g-h>0&&(e.informations="ATTENTION : IL EST TEMPS DE PARTIR POUR RECUPERER VOTRE BIEN")}else console.log(a)})},6e4)},e.addBusStop=function(a){var b={lat:parseFloat(a.lat),lng:parseFloat(a.lon)},c='<div id="content"><div id="siteNotice"></div><h4 id="firstHeading" class="firstHeading">Stop "'+a.stpnm+'" - N° : '+a.stpid+'</h4><div id="bodyContent"><p>Arrêt de bus "'+a.stpnm+'"</p></div></div>',d=new google.maps.InfoWindow({content:c}),f=new google.maps.Marker({position:b,icon:"http://maps.google.com/mapfiles/ms/icons/yellow-dot.png",map:e.map,title:"Stop"});f.addListener("click",function(){d.open(e.map,f)}),e.listStopsMarkers.push(f)},e.resetAll=function(){c.location.reload()},e.init(),e.initMap()}]),angular.module("iamApp").factory("ApiService",["$http",function(a){var b={};return b.api_key="A6P87EzvZRzA2qp385MzeWHR5",b.getDirectionssForRoute=function(c,d){a({method:"GET",url:"http://www.ctabustracker.com/bustime/api/v2/getdirections",withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{format:"json",key:b.api_key,rt:c}}).then(function(a){d(a)},function(a){d(a)})},b.getBusesForRoute=function(c,d){a({method:"GET",url:"http://www.ctabustracker.com/bustime/api/v2/getvehicles",withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{format:"json",key:b.api_key,rt:c}}).then(function(a){d(a)},function(a){d(a)})},b.getStopsForRoute=function(c,d,e){a({method:"GET",url:"http://www.ctabustracker.com/bustime/api/v2/getstops",withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{format:"json",key:b.api_key,rt:c,dir:d}}).then(function(a){e(a)},function(a){e(a)})},b.getVehicle=function(c,d){a({method:"GET",url:"http://www.ctabustracker.com/bustime/api/v2/getvehicles",withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{format:"json",key:b.api_key,vid:c.vid}}).then(function(a){d(a)},function(a){d(a)})},{getDirectionssForRoute:function(a,c){b.getDirectionssForRoute(a,c)},getBusesForRoute:function(a,c){b.getBusesForRoute(a,c)},getStopsForRoute:function(a,c,d){b.getStopsForRoute(a,c,d)},getVehicle:function(a,c){b.getVehicle(a,c)}}}]),angular.module("iamApp").run(["$templateCache",function(a){a.put("views/main.html",'<div class="col-sm-12"> <fieldset class="col-sm-12"> <legend class="col-sm-12">Informations : </legend> <div class="col-sm-12 form-group"> <label class="cols-sm-12 control-label" style="font-size:16px">{{main.informations}}</label> </div> </fieldset> </div> <div class="col-sm-12"> <fieldset class="col-sm-8" ng-disabled="main.isDirectionValid"> <legend class="col-sm-12">Lignes et directions : (<a ng-click="main.resetAll()">Réinitialiser</a>)</legend> <form id="formDirection" ng-submit="main.validateSearch(main.search)"> <div class="col-sm-8"> <div class="col-sm-6 form-group"> <label for="route" class="cols-sm-2 control-label">{{main.labels.route}} :</label> <div class="cols-sm-12"> <div class="input-group"> <input type="text" name="route" size="25" class="form-control" id="route" placeholder="{{main.labels.route}}" ng-model="main.search.route" value="22" disabled> </div> </div> </div> <div class="col-sm-6 form-group"> <label for="direction" class="cols-sm-2 control-label">{{main.labels.direction}} :</label> <div class="cols-sm-12"> <div class="input-group"> <select ng-model="main.search.direction" class="form-control"> <option ng-repeat="direction in main.listDirections.directions" value="{{direction.dir}}">{{direction.dir}}</option> </select> </div> </div> </div> <div class="col-sm-12 form-group"> <div class="col-xs-12 col-md-12 col-lg-12"> <input type="submit" value="{{main.labels.validate}}" class="btn btn-normal btn-md btn-block"> </div> </div> </div> </form> </fieldset> <fieldset class="col-sm-4" ng-disabled="main.isSearchValid" ng-show="main.isDirectionValid"> <legend class="col-sm-12">Arrêts de bus</legend> <form id="formStop" ng-submit="main.searchBus(main.search)"> <div class="col-sm-12 form-group"> <label for="stop" class="cols-sm-2 control-label">{{main.labels.stop}} :</label> <div class="input-group"> <select class="form-control" ng-model="main.search.stop" id="stop"> <option ng-repeat="stop in main.listStops.stops" value="{{stop}}">{{stop.stpnm}}</option> </select> </div> </div> <div class="col-sm-12 form-group"> <div class="col-xs-12 col-md-12 col-lg-12"> <input type="submit" value="{{main.labels.search}}" class="btn btn-success btn-md btn-block"> </div> </div> </form> </fieldset> </div> <div id="map"></div>')}]);